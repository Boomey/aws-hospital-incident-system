// index.js
const AWS = require("aws-sdk");
const s3 = new AWS.S3();
const sns = new AWS.SNS();

exports.handler = async (event) => {
  console.log("S3 Event:", JSON.stringify(event));

  const bucket = event.Records[0].s3.bucket.name;
  const key = decodeURIComponent(event.Records[0].s3.object.key.replace(/\+/g, " "));

  try {
    // Read uploaded file content
    const data = await s3.getObject({ Bucket: bucket, Key: key }).promise();
    const fileContent = data.Body.toString("utf-8");

    // Send to SNS
    await sns.publish({
      TopicArn: process.env.SNS_TOPIC_ARN,   // set this in Lambda environment
      Message: `ðŸš¨ New Incident Report Uploaded\n\n${fileContent}`,
      Subject: "Hospital Incident Report Alert"
    }).promise();

    return {
      statusCode: 200,
      body: JSON.stringify({ message: "SNS notification sent with file content" })
    };

  } catch (err) {
    console.error("Error:", err);
    throw err;
  }
};


